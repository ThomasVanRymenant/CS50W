{% extends "auctions/layout.html" %}
{% load humanize %}
{% block body %}

{% if messages %}
{% for message in messages %}

{% if message.tags == 'success' %}
<div class="alert alert-success" role="alert">
    {{ message }}
</div>
{% endif %}

{% if message.tags == 'error' %}
<div class="alert alert-danger" role="alert">
    {{ message }}
</div>
{% endif %}

{% if message.tags == 'info' %}
<div class="alert alert-info" role="alert">
    {{ message }}
</div>
{% endif %}

{% endfor %}
{% endif %}

{% if not listing %}

<div class="alert alert-warning col-12 col-sm-10" role="alert">
    Whoops! The requested listing doesn't seem to exist. See <a href="{% url 'index' %}">Active listings</a>
</div>

{% else %}

<div class="listing-page mb-3 flex-col" style="flex-wrap: nowrap; align-items: center; width: 100%;">
    <div class="card-shape listing brdr-t-faint px-3 pb-3 col-12 col-md-10" style="max-width: 1100px; display: flex; flex-direction: column; flex-wrap: nowrap;">

        <!-- responsive flexbox / image and listing info -->
        <div class="card-content-container mb-3 mt-0" style="width: 100%; display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center;">

            <!-- image -->
            <div class="image-container pl-0 pr-0 mt-3 flex-row flex-cent-cent col-12 col-md-5" style="overflow: hidden; width: 100%; overflow-x: auto;">
                {% if listing.image_url %}
                <img src="{{ listing.image_url }}" alt="picture of {{ listing.title }}" style="height: 100%;">
                {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" style="height: 250px; width: auto; max-width: 250px; background-size: cover; padding-top: 0.6rem;" viewBox="0 0 600 600">
                    <defs>
                        <style>
                            .cls-1 {
                                fill: #566677;
                            }
                        </style>
                    </defs>
                    <g id="Layer_3" data-name="Layer 3">
                        <rect class="cls-1" x="-21.04" y="234.87" width="642.08" height="20.7" rx="10.35" transform="translate(-87.05 263.29) rotate(-41.94)" />
                        <path class="cls-1" d="M112.67,326.69l93.84-83.88a8.06,8.06,0,0,1,11.07.31l24,24.05L89.77,403.61V81.18a21.79,21.79,0,0,1,21.8-21.79H472.89L447.79,82,121.47,81.2a7.93,7.93,0,0,0-8,7.9Z" />
                        <rect class="cls-1" x="171.24" y="114.43" width="87.19" height="87.19" rx="43.6" />
                        <path class="cls-1" d="M232.1,499.69q2.84,3.24,2.84,9.83t-2.92,10a10.07,10.07,0,0,1-15,0q-3-3.36-2.95-9.88t2.88-9.89a10.41,10.41,0,0,1,15.13,0Zm230.07-12.75v43.59a11.89,11.89,0,0,1-11.89,11.89H149.72a11.89,11.89,0,0,1-11.89-11.89V486.94a11.89,11.89,0,0,1,11.89-11.89H450.28A11.89,11.89,0,0,1,462.17,486.94Zm-262.43,3.54h-7.07v25.6l-15.42-25.6h-7.41v38.34h7.07v-25l15.2,25h7.63ZM242.8,509.7q0-9.36-5-14.61t-13.33-5.26a20.42,20.42,0,0,0-8.12,1.52,14.61,14.61,0,0,0-4.87,3.45,18.16,18.16,0,0,0-3.51,5.25,24.75,24.75,0,0,0-1.72,9.84q0,9.15,5,14.36t13.37,5.22q8.29,0,13.26-5.24T242.8,509.7Zm27.95-19.22h-7.61v38.34h7.61Zm43.55,0H302.88l-6.76,26.15-6.84-26.15H277.89v38.34H285V498.64l7.46,30.18h7.33l7.48-30.18v30.18h7.07Zm41.54,38.34-15.09-38.34h-8L318,528.82h8.07l3.11-8.71h15.06l3.29,8.71Zm38-20.55h-16.4v6.45h8.72v4.87A16.45,16.45,0,0,1,382,521.9a12.83,12.83,0,0,1-4.8,1,9.86,9.86,0,0,1-7.81-3.41q-3-3.41-3-10.23,0-6.33,2.94-9.55a10.24,10.24,0,0,1,7.93-3.21,8.94,8.94,0,0,1,5.49,1.63,8.17,8.17,0,0,1,3,4.46l7.55-1.44a13.55,13.55,0,0,0-5.07-8.28q-3.94-3-11-3a19.21,19.21,0,0,0-9,1.91,16.84,16.84,0,0,0-7.23,7.14,22.42,22.42,0,0,0-2.46,10.64,23.56,23.56,0,0,0,2.21,10.21,15.9,15.9,0,0,0,6.6,7.22,20.38,20.38,0,0,0,10.31,2.52,24.87,24.87,0,0,0,9.19-1.79,20.42,20.42,0,0,0,6.93-4.15Zm35.69,14.09H408.44V511.93h18.92v-6.46H408.44V497h20.34v-6.49H400.83v38.34H429.5Zm-97.95-8.71h10.28l-5.19-14.22Z" />
                        <path class="cls-1" d="M127.2,430.61,268,304.47a7.07,7.07,0,0,1,9.72.26l11.47,11.48,126.3-110.79a9,9,0,0,1,12.3.4l59,59V107.39l22.68-20.26v319.7a23.78,23.78,0,0,1-23.78,23.78Z" />
                    </g>
                </svg>
                {% endif %}
            </div>

            <!-- price, category, auctioner, title etc. -->
            <div class="col-12 col-md-7 pl-0 pt-2 pr-0 flex-col" style="width: 100%;">

                <div class="flex-row mb-4" style="justify-content: end; margin-left:auto">
                    <!-- closer or not -->
                    {% if listing.is_active %}
                    {% if user.id == listing.creator.id %}
                    <div class="custom-btn-wrapper" style="width: 145px;">
                        <a class="btn-small btn-corrected custom-btn1 red-gra" style="width: 100%; color: cornsilk;" href="{% url 'close_auction' listing.id %}" role="button">Close this auction</a>
                    </div>
                    {% endif %}

                    {% endif %}

                    <!-- add/remove watchlist -->
                    {% if listing_is_watched %}
                    <div class="custom-btn-wrapper ml-3" style="width: 180px;">
                        <a href="{% url 'watchlist_remove' listing.id %}" class="btn-small btn-corrected custom-btn1 red-gra" style="width: 100%; color: cornsilk;">Remove from Watchlist</a>
                    </div>
                    {% else %}
                    <div class="custom-btn-wrapper ml-3" style="width: 180px;">
                        <a href="{% url 'watchlist_add' listing.id %}" class="btn-small btn-corrected custom-btn1 grn-gra txt-sft-drk-drkst" style="width: 100%;">Add to Watchlist</a>
                    </div>
                    {% endif %}
                </div>

                <!-- title -->
                <div class="mb-3 pl-3 text-center" style="font-size: 1.2rem;">{{ listing.title }}</div>

                <div class="flex-col" style="align-items: center; font-size: 0.95rem;">

                    {% if listing.is_active %}
                    <!-- show starting price -->
                    <span style="text-align: left;">
                        <div><i>Starting price: <span style="font-family: 'Rubik', sans-serif;"> ${{ listing.starting_bid }}</span></i></div>

                        <!-- show starting price/highest bid -->
                        <div class="mb-3">Current price:
                            {% if listing.highest_bid %}
                            <span class="font-weight-bold" style="font-family: 'Rubik', sans-serif; font-size: 1.5rem;">
                                ${{ listing.highest_bid.amount }}</span>
                            <div style="line-height: 0.8rem;">
                                <small style="color: rgb(114, 114, 114);"> offered {{ listing.highest_bid.date|naturaltime }}
                                    {% if listing.highest_bid.bidder == user %}
                                    <b style="color: rgb(71, 75, 79);">(by you)</b>
                                    {% endif %}
                                </small>
                            </div>

                            {% else %}
                            <span class="font-weight-bold" style="font-family: 'Rubik', sans-serif; font-size: 1.5rem;">
                                ${{ listing.starting_bid }}</span>
                            <small style="color: rgb(114, 114, 114);"> (starting price)</small>
                            {% endif %}
                        </div>
                    </span>

                    <!-- give opportunity to bid -->
                    <div class="flex-row" style="justify-content: center;">
                        <form class="mb-3" action="{% url 'bid' listing.id %}" method="post" style="width: 250px;">
                            {% csrf_token %}
                            {{ bidForm.as_p }}
                            <div class="custom-btn-wrapper" style="width: 100%; border-radius: 20px;">
                                <input class="btn-big btn-corrected custom-btn1 ylw-gra txt-sft-drk-drkst" style="width: 100%; border-radius: 20px;" type="submit" role="button" value="Place Bid">
                            </div>
                        </form>
                    </div>

                    {% else %}

                    <!-- listing is closed -> declare winning bid (if any) -->
                    <div><i>Starting price: <span style="font-family: 'Rubik', sans-serif;"> ${{ listing.starting_bid }}</span></i></div>
                    <span style="color: rgb(218, 0, 0); font-size: 1.6rem; font-weight: 600;" class="text-center">CLOSED</span>

                    {% if listing.highest_bid %}

                    <div style="font-size: 1.5rem;">Winning bid: <span style="font-family: 'Rubik', sans-serif;" class="font-weight-bold">${{ listing.highest_bid.amount }}</span></div>
                    {% if listing.winner == user %}
                    <div style="font-size: 1.5rem;" class="font-weight-bold">Congrats! You won this auction!</div>
                    {% endif %}

                    {% else %}

                    <div class="font-weight-bold" style="font-family: 'Rubik', sans-serif;"><i>This auction got closed before any bids were placed</i></div>

                    {% endif %}

                    {% endif %}
                </div>

                <div class="text-center" style="margin-top: auto;">

                    <!-- category -->
                    {% if listing.category %}
                    <div class="mb-2" style="font-size: 0.9rem; line-height: 1rem;">
                        Category: <a href="{% url 'category_listings' listing.category.name %}">{{ listing.category.name }}</a>
                    </div>
                    {% endif %}

                    <!-- listing creator and date -->
                    <div class="mb-0" style="color: rgb(85, 85, 85); font-size: 0.9rem; line-height: 1rem;">
                        Listed <b>{{ listing.creationDateTime|naturaltime }}</b> by <b>{{ listing.creator }}</b>
                    </div>

                </div>

            </div>
        </div>

        <!-- 2nd (vertical) flexbox of card / listing's description and comment section -->
        <div>
            <!-- description -->
            <div class="mb-3 pb-0">{{ listing.description }}</div>

            <div class="bx-sha mb-4 rounded-h" style="width: 100%; height: 5px; box-shadow: 0px -5px 5px white, 0px 2px 3px rgba(0, 0, 0, 0.55) !important;">
            </div>

            <!-- comment form -->
            {% if listing.is_active %}

            <form class="mb-3 pb-1" action="{% url 'add_comment' listing.id %}" method="POST">
                {% csrf_token %}
                <div class="form-group">
                    {{ commentForm.as_p }}
                </div>

                <div class="custom-btn-wrapper" style="width: 150px; margin-left: auto;">
                    <input class="btn-big btn-corrected custom-btn1 blu-gra" style="color: cornsilk; width: 100%;" type="submit" value="Place comment">
                </div>
            </form>

            <div class="bx-sha mb-4 rounded-h" style="width: 100%; height: 5px; box-shadow: 0px -5px 5px white, 0px 2px 3px rgba(0, 0, 0, 0.55) !important;">
            </div>

            {% endif %}

            <!-- comments title -->
            <h4>
                Comments: ({{ comments_amount }})
                {% if listing.is_active == False %}
                <small style="color: rgb(114, 114, 114);">archived</small>
                {% endif %}
            </h4>

            <!-- comments -->
            {% if comments %}
            {% for comment in comments %}

            <!-- comment block -->
            <div class="brdr-b-faint mt-2" style="width: 100%;">
                <!-- content -->
                <div>{{ comment.comment }}</div>
                <div class="pb-0" style="width: fit-content; font-size: 0.8rem; color: rgb(85, 85, 85); margin-left: auto; text-align: end;">
                    <b>{{ comment.date|naturaltime }}</b> by <b>{{ comment.commentator }}</b>
                </div>
            </div>

            {% endfor %}
            {% endif %}

        </div>
    </div>
</div>
{% endif %}
{% endblock %}